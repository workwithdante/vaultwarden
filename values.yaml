vaultwarden:
  domain: "https://vault.mabecenter.org"
  invitationOrgName: "MABECENTER"

  commonAnnotations:
    backup.velero.io/backup-volumes: "vaultwarden-data, vaultwarden-files"

  podAnnotations:
    backup.velero.io/backup-volumes: "vaultwarden-data, vaultwarden-files"

  ingress:
    enabled: true
    hostname: vault.mabecenter.org
    class: "traefik"
    tls: true
    additionalAnnotations:
      traefik.ingress.kubernetes.io/scheme: internet-facing
      traefik.ingress.kubernetes.io/target-type: ip
      traefik.ingress.kubernetes.io/tags: Environment=dev,Team=test
      traefik.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:eu-central-1:ACCOUNT:certificate/LONGID"

  initContainers:
    - name: kopia-sync-to-rclone
      image: docker.io/kopia/kopia:latest
      command: [sh, -c]
      args:
        - |
          echo "[üîÑ] Sincronizando repositorio de Kopia a rclone..."

          kopia repository connect s3 --bucket=$BUCKET --access-key=$AWS_ACCESS_KEY_ID --secret-access-key=$AWS_SECRET_ACCESS_KEY --prefix=$PATH_PREFIX --endpoint=$RCLONE_CONFIG_S3_ENDPOINT --password=$KOPIA_PASSWORD --no-persist-credentials
          
          SNAPSHOT_LIST=$(kopia snapshot list --all -l --json)

          DATA_SNAPSHOT_OBJ=$(echo "$SNAPSHOT_LIST" | awk -F'"obj":"' '/"volume":"vaultwarden-data"/ {print $2}' | awk -F'"' '{print $1}')

          FILES_SNAPSHOT_OBJ=$(echo "$SNAPSHOT_LIST" | awk -F'"obj":"' '/"volume":"vaultwarden-files"/ {print $2}' | awk -F'"' '{print $1}')

          echo "[üìÅ] Restaurando base de datos..."
          kopia snapshot restore $DATA_SNAPSHOT_OBJ /data

          echo "[üìÅ] Restaurando attachments..."
          kopia snapshot restore $FILES_SNAPSHOT_OBJ /files 

      volumeMounts:
      - name: vaultwarden-data
        mountPath: /data
      - name: vaultwarden-files
        mountPath: /files

      env:
        - name: KOPIA_PASSWORD
          value: static-passw0rd
        - name: BUCKET
          value: vault-backups
        - name: PATH_PREFIX
          value: kopia/vaultwarden/
        - name: RCLONE_CONFIG_S3_TYPE
          value: s3
        - name: RCLONE_CONFIG_S3_PROVIDER
          value: AWS
        - name: RCLONE_CONFIG_S3_REGION
          value: us-east-2
        - name: RCLONE_CONFIG_S3_ENV_AUTH
          value: "true"
        - name: RCLONE_CONFIG_S3_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: endpoint
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: accessKey
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: secretKey

  adminToken:
    existingSecret: vaultwarden-secret
    existingSecretKey: ADMIN_TOKEN

  smtp:
    host: "mail.mabecenter.org"
    security: "force_tls"
    port: 465
    from: "no-reply@mabecenter.org"
    fromName: "Vaultwarden Mabecenter"
    existingSecret: "vaultwarden-smtp-secret"
    username:
      existingSecretKey: SMTP_USERNAME
    password:
      existingSecretKey: SMTP_PASSWORD

  storage:
    data:
      name: vaultwarden-data
      class: nfs
      size: 15Gi
      path: /data
      accessMode: ReadWriteOnce
    attachments:
      name: vaultwarden-files
      class: nfs
      size: 10Gi
      path: /files
      accessMode: ReadWriteOnce
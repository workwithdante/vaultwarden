
vaultwarden:
  domain: "https://vaultwarden.mabecenter.org"
  invitationOrgName: "MABECENTER"

  ingress:
    enabled: true
    hostname: vaultwarden.mabecenter.org
    class: "traefik"
    additionalAnnotations:
      traefik.ingress.kubernetes.io/scheme: internet-facing
      traefik.ingress.kubernetes.io/target-type: ip
      traefik.ingress.kubernetes.io/tags: Environment=dev,Team=test
      traefik.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:eu-central-1:ACCOUNT:certificate/LONGID"

  adminToken:
    existingSecret: vaultwarden-secret
    existingSecretKey: ADMIN_TOKEN
  
  smtp:
    host: "mail.mabecenter.org"
    security: "force_tls"
    port: 465
    from: "no-reply@mabecenter.org"
    fromName: "Vaultwarden Mabecenter"
    existingSecret: "vaultwarden-smtp-secret"
    username:
      existingSecretKey: SMTP_USERNAME
    password:
      existingSecretKey: SMTP_PASSWORD

  initContainers:
    - name: restore-vaultwarden-backup
      image: rclone/rclone:latest
      command: [sh, -c]
      args:
        - |
          echo "[üîÑ] Descargando backup desde S3..."

          mkdir -p /restore

          # Buscar el backup m√°s reciente
          BACKUP_FILE=$(rclone lsf s3: | grep .tar.gz | sort | tail -n 1)

          echo "√öltimo backup: $BACKUP_FILE"

          rclone copy s3:$BACKUP_FILE /restore

          echo "[üì¶] Extrayendo..."
          tar -xzf /restore/$BACKUP_FILE -C /restore

          echo "[üìÅ] Restaurando con rsync..."
          rsync -a /restore/ /data/

          echo "[‚úÖ] Restauraci√≥n finalizada"

      volumeMounts:
        - name: vaultwarden-data
          mountPath: /data
        - name: rclone-config
          mountPath: /config/rclone
      env:
        - name: RCLONE_CONFIG_S3_TYPE
          value: s3
        - name: RCLONE_CONFIG_S3_PROVIDER
          value: AWS
        - name: RCLONE_CONFIG_S3_REGION
          value: us-east-1
        - name: RCLONE_CONFIG_S3_ENV_AUTH
          value: "true"
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: accessKey
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: secretKey

  volumes:
  - name: vaultwarden-data
    persistentVolumeClaim:
      claimName: vaultwarden-pvc
